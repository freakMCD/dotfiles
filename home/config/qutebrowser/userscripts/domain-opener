#!/usr/bin/env python3
import os
import sys
from urllib.parse import urlparse

# Debug log
DEBUG_LOG = "/tmp/domain-opener.log"

def log(message):
    with open(DEBUG_LOG, "a") as f:
        f.write(f"{message}\n")

def get_domain(url):
    """Extract the base domain from a URL."""
    try:
        netloc = urlparse(url).netloc
        parts = netloc.split('.')
        # Handle cases like "www.youtube.com" -> "youtube.com"
        return '.'.join(parts[-2:]) if len(parts) >= 2 else netloc
    except:
        return ""

def is_same_domain(current_url, hinted_url):
    """Check if two URLs share the same base domain."""
    current_domain = get_domain(current_url)
    hinted_domain = get_domain(hinted_url)
    return current_domain == hinted_domain

# Log environment variables
log("Environment Variables:")
for key, value in os.environ.items():
    log(f"{key}={value}")

# Get current URL and hinted URL from environment
current_url = os.environ.get("QUTE_CURRENT_URL", "")
hinted_url = os.environ.get("QUTE_URL", "")

# Validate URLs
if not current_url or not hinted_url:
    log("ERROR: QUTE_CURRENT_URL or QUTE_URL not set.")
    sys.exit(1)

log(f"Current URL: {current_url}")
log(f"Hinted URL: {hinted_url}")

# Determine if the URLs share the same domain
if is_same_domain(current_url, hinted_url):
    cmd = f"open -t {hinted_url}"  # Open in the same window (tab)
else:
    cmd = f"open -w {hinted_url}"  # Open in a new window

log(f"Command: {cmd}")

# Send command to qutebrowser
try:
    with open(os.environ["QUTE_FIFO"], "w") as fifo:
        fifo.write(cmd + "\n")
    log("Command sent successfully!")
except Exception as e:
    log(f"FIFO Error: {str(e)}")
    sys.exit(1)

