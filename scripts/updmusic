#!/usr/bin/env bash
set -euo pipefail
trap 'echo -e "\nScript interrupted. Exiting..."; exit' SIGINT

BASE_DIR="$HOME/Music"
COOKIES_FROM_BROWSER="firefox:~/.librewolf/bixoef6e.default"
YTDLP_CONF="$HOME/nix/scripts/yt-dlp/yt-dlp.conf"

# --- Playlists: "Name|URL" ---
PLAYLISTS=(
  "The Hall|https://www.youtube.com/playlist?list=PL4CmunqMOJjKi1Mtlc3N5pedFJ5UgFobk"
  "Ethereal|https://www.youtube.com/playlist?list=PL4CmunqMOJjLFhIqJ3w5v6htEwPKMXxBx"
)

# --- Colors ---
CYAN='\033[0;36m'; YELLOW='\033[1;33m'; GREEN='\033[0;32m'
MAGENTA='\033[0;35m'; DIM='\033[2;37m'; NC='\033[0m'

mkdir -p "$BASE_DIR"
cd "$BASE_DIR"

rebuild_archive_from_dir() {
  local dir="$1" archive="$2"
  if [[ -d $dir ]]; then
    find "$dir" -type f \( -iname '*.m4a' -o -iname '*.mp3' -o -iname '*.webm' \) -printf '%f\n' 2>/dev/null \
      | sed -E 's/.*\[([A-Za-z0-9_-]{11})\]\..*$/youtube \1/' \
      | grep -E '^youtube [A-Za-z0-9_-]{11}$' \
      | sort -u > "$archive"
  else
    : > "$archive"
  fi
}

download_playlist() {
  local name="$1" url="$2" outdir="$3" archive="$4" counter=0
  echo -e "⭐ Downloading ${YELLOW}$name${NC}…"

  while IFS= read -r line; do
    ((counter++))
    local file title video_id
    file=$(basename "$line")
    title="${file% \[*}"
    video_id=$(grep -oE '\[([A-Za-z0-9_-]{11})\]' <<<"$file" | tr -d '[]')
    echo -e "${GREEN}✔ ${CYAN}$title ${YELLOW}[$video_id]${NC}"
  done < <(
    yt-dlp --quiet \
      --config-locations "$YTDLP_CONF" \
      --cookies-from-browser "$COOKIES_FROM_BROWSER" \
      --download-archive "$archive" \
      -o "$outdir/%(title)s [%(id)s].%(ext)s" \
      --parse-metadata " $name: %(meta_artist)s" \
      --print after_move:"%(_filename)s" \
      "$url"
  )

  if ((counter > 0)); then
    echo -e "${GREEN}✓ Added ${YELLOW}$counter${GREEN} track$([ $counter -ne 1 ] && echo "s") to ${YELLOW}$name${NC}\n"
  else
    echo -e "${MAGENTA}↳ ${DIM}$name is already up to date${NC}\n"
  fi
}

# --- Main loop ---
total_count=0
for entry in "${PLAYLISTS[@]}"; do
  IFS="|" read -r name url <<<"$entry"
  outdir="$BASE_DIR/$name"
  archive="$outdir/downloaded.txt"

  mkdir -p "$outdir"
  rebuild_archive_from_dir "$outdir" "$archive"
  download_playlist "$name" "$url" "$outdir" "$archive"

  count=$(wc -l < "$archive" 2>/dev/null || echo 0)
  printf " - %-9s %s\n" "$name:" "$count"
  total_count=$((total_count + count))
done

echo -e "✅ Total: $total_count"

